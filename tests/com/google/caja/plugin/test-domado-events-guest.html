<!--
 - Copyright (C) 2011 Google Inc.
 -
 - Licensed under the Apache License, Version 2.0 (the "License");
 - you may not use this file except in compliance with the License.
 - You may obtain a copy of the License at
 -
 -      http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
-->

<script type="text/javascript">
  function installOneShotOnerror(testId, expectedMessage) {
    var savedOnerror = window.onerror;
    window.onerror = function(message, url, line) {
      assertEquals(expectedMessage, message);
      assertTrue('window == ' + this, window == this);
      window.onerror = savedOnerror;
      pass(testId);
    };
  }
</script>

<div class="clickme testcontainer" id="testEventBubble">
  testEventBubble
  <input type="checkbox">
</div>
<script type="text/javascript">
  jsunitRegister('testEventBubble', function testEventBubble() {
    function listener(e) {
      if (e.currentTarget.id === 'testEventBubble') {
        pass('testEventBubble');
      } else {
        fail('testEventBubble');
      }
    }
    var parent = document.getElementById('testEventBubble');
    parent.addEventListener('change', listener, false);
  });
</script>

<p class="clickme testcontainer" id="testExceptionInEventHandler">
  <span onclick="die();">
    click me.  Exceptions in event handlers should invoke onerror.
  </span>
</p>
<script type="text/javascript">
  window.die = function die() {
    installOneShotOnerror(
        'testExceptionInEventHandler',
        'Uncaught Error: died!');
    throw new Error('died!');
  };
  jsunitRegister('testExceptionInEventHandler',
                 function testExceptionInEventHandler() { });
</script>

<p class="clickme testcontainer" id="testFunctionCallsInAttributes">
  <span onclick="doIt(event, this);">
    click me.  Function calls in attributes should work.
  </span>
</p>
<script type="text/javascript">
  window.doIt = function doIt(event, node) {
    if ((event instanceof Event) && (node instanceof HTMLElement)) {
      pass('testFunctionCallsInAttributes');
    } else {
      console.error('testFunctionCallsInAttributes: wrong args event=', event,
          'node=', node);
    }
  };
  jsunitRegister('testFunctionCallsInAttributes',
                 function testFunctionCallsInAttributes() { });
</script>

<p class="clickme testcontainer" id="testCodeInAttributes">
  <span onclick="if (true) pass('testCodeInAttributes');">
    click me.  Nontrivial code in event handler attributes should work.
  </span>
</p>
<script type="text/javascript">
  jsunitRegister('testCodeInAttributes',
                 function testCodeInAttributes() { });
</script>

<p class="testcontainer" id="testRejectedHandlerString">
  testRejectedHandlerString -- Rejected complex handlers should still be
  attributes (expected by jQuery).
  TODO(kpreid): This test is no longer relevant. Check if anything to salvage.
</p>
<script type="text/javascript">
  jsunitRegister('testRejectedHandlerString',
                 function testRejectedHandlerString() {
    var elem = document.getElementById('testRejectedHandlerString');

    elem.setAttribute('onclick', 'foo');
    
    assertEquals('virtual atribute string', 'string',
        typeof elem.getAttribute('onclick'));
    assertEquals('host attribute string', 'string',
        typeof directAccess.getAttribute(elem, 'onclick'));
    assertTrue(
        'onclick node (' + elem.getAttributeNode('onclick') + ') exists',
        elem.getAttributeNode('onclick') instanceof Attr);
    // TODO(kpreid): This should work too and is what jQuery is doing, but we
    // don't have named .attributes lookup yet.
    //assertTrue(
    //    '.attributes.onclick (' + elem.attributes.onclick + ') exists',
    //    elem.attributes.onclick instanceof Attr);

    pass('testRejectedHandlerString');
  });
</script>

<p class="manual testcontainer" id="testRelatedTarget-mouse-container">
  <span id="testRelatedTarget-mouse">
    Move mouse here to see event.relatedTarget.
    Rapid motion from outside sandbox should show a null relatedTarget.
  </span>
  <br />
  <span id="testRelatedTarget-mouse-info">&nbsp;</span>
</p>
<p class="clickme testcontainer" id="testRelatedTarget">
  <b id="testRelatedTarget-child">click me (testRelatedTarget)
  </b>
</p>
<script type="text/javascript">
  jsunitRegister('testRelatedTarget',
                 function testRelatedTarget() {
    var childClick = jsunitCallback(function (event) {
      // get should work.  in manual clicks, relatedTarget is null, but in
      // webdriver simulated clicks, it's non-null.
      assertEquals(event.relatedTarget, event.relatedTarget);
      // set doesn't have to work, but shouldn't throw an error
      event.relatedTarget = [];
      pass('testRelatedTarget');
    });

    var child = document.getElementById('testRelatedTarget-child');
    child.addEventListener('click', childClick, false);

    // TODO: webdriver doesn't have a good way of testing relatedTarget.
    // there are two cases we care about: relatedTarget is an element in the
    // sandbox, and relatedTarget is an element outside the sandbox.

    var mouseReport = jsunitCallback(function (event) {
      var r = event.relatedTarget;
      r = r && (r.tagName + '#' + r.id);
      info.innerHTML = event.type + ' ' + String(r);
    });

    var mouse = document.getElementById('testRelatedTarget-mouse');
    var info = document.getElementById('testRelatedTarget-mouse-info');
    mouse.addEventListener('mouseover', mouseReport, false);
    mouse.addEventListener('mouseout', mouseReport, false);
  });
</script>

<p class="clickme testcontainer" id="testListenerArguments">
  <b id="testListenerArguments-label">click me: testListenerArguments</b>
</p>
<script type="text/javascript">
  jsunitRegister('testListenerArguments',
                 function testListenerArguments() {
    var container = document.getElementById('testListenerArguments-label');
    container.addEventListener(
        'click',
        jsunitCallback(
            function eventListener(event) {
              assertEquals(1, arguments.length);
              assertEquals('click', event.type);
              pass('testListenerArguments');
            }));
  });
</script>

<p class="clickme testcontainer" id="testHandlerArguments">
  <b id="testHandlerArguments-label">click me: testHandlerArguments</b>
</p>
<script type="text/javascript">
  jsunitRegister('testHandlerArguments',
                 function testHandlerArguments() {
    var container = document.getElementById('testHandlerArguments-label');
    container.onclick = jsunitCallback(
        function eventListener(event) {
          assertEquals(1, arguments.length);
          assertEquals('click', event.type);
          pass('testHandlerArguments');
        });
  });
</script>

<div class="clickme testcontainer" id="testHandlerAttributeArguments0">
  testHandlerAttributeArguments0 -- Handler-called functions should not get
  extra parameters.
  <div id="testHandlerAttributeArguments0-div"><b>click me: 0 args</b></div>
</div>
<script type="text/javascript">
  jsunitRegister('testHandlerAttributeArguments0',
                 function testHandlerAttributeArguments0() {
    document.getElementById('testHandlerAttributeArguments0-div')
        .setAttribute('onclick', 'testHandlerAttributeArguments_go0();');
    window.testHandlerAttributeArguments_go0 = jsunitCallback(
        function handlerCalledFn() {
          console.log('go0', Array.prototype.slice.call(arguments));
          assertEquals('length', 0, arguments.length);
          pass('testHandlerAttributeArguments0');
        });
  });
</script>

<div class="clickme testcontainer" id="testHandlerAttributeArguments2">
  testHandlerAttributeArguments2 -- Handler-called functions should not get
  extra parameters.
  <div id="testHandlerAttributeArguments2-div"><b>click me: 2 args</b></div>
</div>
<script>
  jsunitRegister('testHandlerAttributeArguments2',
                 function testHandlerAttributeArguments2() {
    document.getElementById('testHandlerAttributeArguments2-div')
        .setAttribute('onclick',
            'testHandlerAttributeArguments_go2(event, this);');
    window.testHandlerAttributeArguments_go2 = jsunitCallback(
        function handlerCalledFn() {
          console.log('go2', Array.prototype.slice.call(arguments));
          assertEquals('length', 2, arguments.length);
          assertTrue('first arg', arguments[0] instanceof Event);
          assertTrue('second arg', arguments[1] ===
              document.getElementById('testHandlerAttributeArguments2-div'));
          pass('testHandlerAttributeArguments2');
        });
  });
</script>

<p class="clickme testcontainer" id="testAddEventListener">
  <b id="testAddEventListener-label">click me</b>
</p>
<script type="text/javascript">
  jsunitRegister('testAddEventListener',
                 function testAddEventListener() {
    var container = document.getElementById('testAddEventListener-label');
    container.addEventListener(
        'click',
        jsunitCallback(
            function eventListener(event) {
              console.log('received event');
              assertEquals('B', event.target.tagName);
              assertEquals('click', event.type);
              pass('testAddEventListener');
            }));
    expectFailure(
        function() {
          container.addEventListener('foo');
        },
        'addEventListener of a string');
    expectFailure(
        function() {
          container.addEventListener({});
        },
        'addEventListener of an ordinary object');
  });
</script>

<p class="testcontainer" id="testDocumentDomContentLoaded">
  Waiting for DOMContentLoaded.
</p>
<script type="text/javascript">
  (function() {
    var event, args;
    document.addEventListener(
        'DOMContentLoaded',
        function eventListener(e) {
          event = e;
          args = arguments;
        });
    jsunitRegister('testDocumentDomContentLoaded',
                   function testDocumentDomContentLoaded() {

      assertAsynchronousRequirement(
          'event fired',
          function() { return !!event; },
          function() {
        assertEquals('DOMContentLoaded', event.type);
        assertEquals(1, args.length);
      });

      pass('testDocumentDomContentLoaded');
    });
  })();
</script>

<p class="clickme testcontainer" id="testRemoveEventListener">
  <b id="testRemoveEventListener-label">click me</b>
</p>
<script type="text/javascript">
  jsunitRegister('testRemoveEventListener',
                 function testRemoveEventListener() {
    var container = document.getElementById('testRemoveEventListener-label');
    var firstFired = false;
    var failed = false;
    var second = jsunitCallback(
        function secondcb(event) {
          console.log('received event');
          if (failed) { return; }
          assertEquals('B', event.target.tagName);
          assertEquals('click', event.type);
          event.target.innerHTML = 'All done!';
          pass('testRemoveEventListener');
        });
    var first = jsunitCallback(
        function firstcb(event) {
          if (firstFired) {
            event.target.innerHTML =
                '<b>FAILED - event handler was not removed!</b>';
            failed = true;
            return;
          }
          firstFired = true;
          console.log('received event');
          assertEquals('B', event.target.tagName);
          assertEquals('click', event.type);
          event.target.innerHTML = 'Thank you, click me again please';
          container.removeEventListener('click', first);
          container.addEventListener('click', second);
        });
    container.addEventListener('click', first);
  });
</script>

<p class="clickme testcontainer" id="testRepeatedHandlers">
  <b id="testRepeatedHandlers-label">testRepeatedHandlers - click me
      2 times</b>
</p>
<script type="text/javascript">
  jsunitRegister('testRepeatedHandlers',
                 function testRepeatedHandlers() {
    // an element containing the one being clicked on
    var container = document.getElementById('testRepeatedHandlers');
    var events = [];
    var recordA = jsunitCallback(function(event) {
      events.push(['A', event.type, event.eventPhase]);
    });
    var recordB = jsunitCallback(function(event) {
      events.push(['B', event.type, event.eventPhase]);
    });

    // multiple adds with identical args should be ignored

    container.addEventListener('mouseup', function junk1() {}, true);
    container.addEventListener('mouseup', recordA, true);
    container.addEventListener('mouseup', function junk2() {}, true);
    container.addEventListener('mouseup', recordA, true);

    container.addEventListener('mouseup', recordA, false);
    container.addEventListener('mouseup', function junk3() {}, false);
    container.addEventListener('mouseup', recordA, false);
    container.addEventListener('mouseup', function junk4() {}, false);

    container.addEventListener('mouseup', recordB, true);
    container.addEventListener('mouseup', function junk5() {}, true);
    container.addEventListener('mouseup', recordB, true);

    container.addEventListener('mouseup', function junk6() {}, false);
    container.addEventListener('mouseup', recordB, false);
    container.addEventListener('mouseup', recordB, false);
    container.addEventListener('mouseup', function junk7() {}, false);

    var phase = 0;
    var check = jsunitCallback(function(event) {
      switch (++phase) {
      case 1:
        assertEquals(
          'first', 'A,mouseup,1,B,mouseup,1,A,mouseup,3,B,mouseup,3',
          String(events));
        events = [];
        // remove one of the event listeners and check again
        container.removeEventListener('mouseup', recordA, false);
        break;
      case 2:
        assertEquals(
          'second', 'A,mouseup,1,B,mouseup,1,B,mouseup,3',
          String(events));
        events = [];
        pass('testRepeatedHandlers');
        container.removeEventListener('mouseup', check, false);
        break;
      default:
        // ignore extra clicks
        break;
      }
    });
    container.addEventListener('mouseup', check, false);
  });
</script>

<p class="waiting testcontainer" id="testTimeoutAndInterval">
  Timeouts and Intervals<br>
</p>
<script type="text/javascript">
  jsunitRegister('testTimeoutAndInterval',
                 function testTimeoutAndInterval() {
    var timeout1Ran = false,
        timeout2Ran = false;
    var timeout1Id = setTimeout(jsunitCallback(
        function to1Id() { timeout1Ran = true; }), 50);
    var timeout2Id = setTimeout(jsunitCallback(
        function to2Id() { timeout2Ran = true; }), 50);
    clearTimeout(timeout1Id);

    var intervalRunIndex = -1;
    var interval1RunCount = 0,
        interval2RunCount = 0;
    var interval1Id = setInterval(jsunitCallback(
        function iv1id() { ++interval1RunCount; }), 50);
    var interval2Id = setInterval(jsunitCallback(
        function iv2id() { ++interval2RunCount; }), 50);

    // Check that null is a noop as a timeout or interval value, and that the
    // return value works with clearTimeout and clearInterval and does not
    // inadvertently clear existing timeouts or intervals.
    clearTimeout(setTimeout(null, 0));
    clearInterval(setInterval(null, 0));

    // Check that clearInterval and clearTimeout ignore null
    // and undefined intervalId's
    clearInterval(null);
    clearInterval(void 0);
    clearInterval('1');
    clearInterval({ intervalId : 1 });
    clearInterval(clearInterval);
    clearInterval(timeout2Id);
    clearTimeout(null);
    clearTimeout(void 0);
    clearTimeout('1');
    clearTimeout({ intervalId : 1 });
    clearTimeout(clearTimeout);
    clearTimeout(interval1Id);

    setTimeout(
        jsunitCallback(function () {
          clearInterval(interval2Id);
          setTimeout(
              jsunitCallback(function () {
                if (!timeout1Ran && timeout2Ran
                    && interval1RunCount > interval2RunCount) {
                  clearInterval(interval1Id);
                  pass('testTimeoutAndInterval');
                }
              }),
              500);
        }),
        200);
  });
</script>

<p class="testcontainer" id="testTimeoutError">
  testTimeoutError (error handling in setTimeout)
</p>
<script type="text/javascript">
  jsunitRegister('testTimeoutError', function() {
    setTimeout(function() {  // NOT a jsunitCallback, must let error out
      installOneShotOnerror(
          'testTimeoutError',
          'Uncaught Error: foo');
      throw new Error('foo');
    }, 0);
  });
</script>

<p class="testcontainer" id="testRequestAnimationFrame">
  requestAnimationFrame<br>
</p>
<script type="text/javascript">
  var hasRAF = directAccess.evalInHostFrame('!!window.requestAnimationFrame');
  jsunitRegisterIf(hasRAF,
                   'testRequestAnimationFrame',
                   function testRequestAnimationFrame() {
    // We use the same cancel-wrapper as setTimeout does, so not bothering to
    // test cancel matching, just that the functionality works.
    
    var frame1Ran = 0;
    var frame2Ran = 0;
    var frame2Time = -1;
    var frame3Ran = 0;
    function r1f(time) { frame1Ran++; }
    function r2f(time) { frame2Ran++; frame2Time = time; }
    function r3f(time) {
      assertEquals('2 before 3', 2, frame2Ran);
      assertEquals('same time as previous callback', frame2Time, time);
      frame3Ran++;
      final();
    }

    var r1 = requestAnimationFrame(r1f);
    var r21 = requestAnimationFrame(r2f);
    var r22 = requestAnimationFrame(r2f);  // spec'd to queue duplicate
    var r3 = requestAnimationFrame(jsunitCallback(r3f));
    
    var cr = cancelAnimationFrame(r1);
    assertEquals('cancel return value', undefined, cr);
    cancelAnimationFrame(undefined);  // should not fail
    
    var final = jsunitCallback(function final_() {
      requestAnimationFrame(jsunitCallback(function(time) {
        assertEquals('final #1', 0, frame1Ran);
        assertEquals('final #2', 2, frame2Ran);
        assertEquals('final #3', 1, frame3Ran);
        assertTrue('timing (' + frame2Time + ' ' + time + ')',
            frame2Time < time);
        pass('testRequestAnimationFrame');
      }));
    });
  });
</script>

<p class="testcontainer" id="testStringTimeout">testStringTimeout</p>
<script type="text/javascript">
  (function() {
    // Register global functions to be called via string callbacks
    var successes = {};
    ['testStringTimeout_str', 'testStringTimeout_toString']
        .forEach(function(funcName) {
      successes[funcName + ' '] = false;
      window[funcName] = jsunitCallback(function() {
        console.log('testStringTimeout: called', funcName);
        successes[funcName + ' '] = true;

        if (Object.keys(successes).every(
            function(k) { return successes[k]; })) {
          testStringTimeout_finish();
        }
      }, 'testStringTimeout');
    });
  }());
  jsunitRegister('testStringTimeout',
                 function testStringTimeout() {
    setTimeout('testStringTimeout_str();', 0);
    setTimeout(
        {toString: function() {return 'testStringTimeout_toString();';}}, 0);
  });
  function testStringTimeout_finish() {
    pass('testStringTimeout');
  }
</script>

<p class="clickme testcontainer" id="testInnerhtmlOnclick">
  do not click yet
</p>
<script type="text/javascript">
  window.innerhtmlClicked = function() {
    pass('testInnerhtmlOnclick');
  };

  jsunitRegister('testInnerhtmlOnclick',
                 function testInnerhtmlOnclick() {
    var el = document.getElementById('testInnerhtmlOnclick');
    el.innerHTML = '<b onclick="innerhtmlClicked();">Click me to call innerhtmlClicked()</b>';
  });
</script>

<p class="clickme testcontainer" id="testOnclickHandler">
  <b id="testOnclickHandler-label"
     onclick="passTestOnclickHandler();">click me</b>
</p>
<script type="text/javascript">
  window.passTestOnclickHandler = function passTestOnclickHandler() {
    pass('testOnclickHandler');
  };
  jsunitRegister('testOnclickHandler',
                 function testOnclickHandler() {
    // Nothing to do here.  pass call in testOnclickHandler HTML.
  });
</script>

<!--
TODO(felix8a): fix javascript url handling
  es53 fails because IMPORTS___.handlers___ doesn't exist.
  ses fails because the js urls don't get rewritten so execute in the feral context.
<p class="clickme testcontainer" id="test-jsuri">
  <a id="test-jsuri-label" href="javascript:alert(1)+pass('test-jsuri')">click JS URL</a>
</p>
<script type="text/javascript">
  jsunitRegister('testJsUri',
                 function testJsUriHandler() {
    // Nothing to do here.  pass call in test-jsuri HTML.
  });
</script>
-->

<p class="clickme testcontainer" id="testCurrentTarget">
  <b id="testCurrentTarget-child">click me</b>
</p>
<script type="text/javascript">
  jsunitRegister('testCurrentTarget',
                 function testCurrentTarget() {
    var parent = document.getElementById('testCurrentTarget');
    var child = document.getElementById('testCurrentTarget-child');
    var gotChildClick = false;

    var childClick = jsunitCallback(function (event) {
      assertEquals('testCurrentTarget-child', event.currentTarget.id);
      gotChildClick = true;
    });

    var parentClick = jsunitCallback(function (event) {
      assertEquals('testCurrentTarget', event.currentTarget.id);
      assertTrue(gotChildClick);
      pass('testCurrentTarget');
    });

    parent.addEventListener('click', parentClick, false);
    child.addEventListener('click', childClick, false);
  });
</script>

<p class="testcontainer" id="testLoadEvents">
  Load events sequencing and bubbling
</p>
<script>
  (function() {
    var events = [];
    var additionalError;

    jsunitRegister('testLoadEvents', function() {
      assertEquals(
        'w,DOMContentLoaded,1,true ' +
        'd,DOMContentLoaded,2,true ' +
        'd,DOMContentLoaded,2,false ' +
        'w,DOMContentLoaded,3,false ' +
        'w,load,0,handler ' +
        'w,load,2,true ' +
        'w,load,2,false',
        events.join(' '));
      pass('testLoadEvents');
    });

    function makeListener(node, type, expectTarget, capture) {
      function inner(thisArg, event) {
        if (capture && event.target && event.target.nodeName === 'SCRIPT') {
          // ignore captured script node load events
          return;
        }

        var str = event.type + ' @ ' + node + ' phase ' + event.eventPhase;
        console.log(str);
        document.getElementById('testLoadEvents')
            .appendChild(document.createElement('div'))
            .appendChild(document.createTextNode(str));

        // done before asserts so overall events check can also run
        var tshort = thisArg === window ? 'w' : thisArg === document ? 'd' :
            thisArg;
        events.push([tshort, event.type, event.eventPhase, capture]);

        assertTrue('event phase',
            capture ? event.eventPhase !== 3 : event.eventPhase !== 1);
        assertEquals('event type', type, event.type);
        assertTrue('listener this (' + thisArg + ')', thisArg === node);
        assertTrue('event target (' + event.target + ')',
            event.target === expectTarget);
      }
      // jsunitCallback doesn't pass 'this' and even if it did it would be
      // through the membrane
      var callback = jsunitCallback(inner, 'testLoadEvents');
      return function(event) { return callback(this, event); };
    }
    function record(node, expectTarget, type) {
      [true, false].forEach(function(capture) {
        node.addEventListener(
            type,
            makeListener(node, type, expectTarget, capture),
            capture);
      });
    }

    window.onload = function(event) {
      try {
        events.push([this === window ? 'w' : this, event.type,
            event.eventPhase, 'handler']);
      } catch (e) {
        fail('testLoadEvents', e);
      }
    };

    record(window, document, 'DOMContentLoaded');
    record(document, document, 'DOMContentLoaded');
    record(window, window, 'load');
    record(document, window, 'load');
  })();
</script>

<p class="testcontainer" id="testRemoveSpecialHandler">
  testRemoveSpecialHandler
</p>
<script type="text/javascript">
  (function() {
    var nok = false;
    function h() {
      nok = true;
    }
    window.addEventListener('load', h);
    window.removeEventListener('load', h);

    jsunitRegister('testRemoveSpecialHandler',
                   function testRemoveSpecialHandler() {
      assertFalse(nok);
      pass('testRemoveSpecialHandler');
    });
  })();
</script>

<div id="testXhrInstanceProps" class="testcontainer">XHR instance props</div>
<script type="text/javascript">
  jsunitRegister('testXhrInstanceProps',
                 function testXhrInstanceProps() {
    var xhr = new window.XMLHttpRequest();
    xhr.x = 1;
    assertEquals(1, xhr.x);
    pass('testXhrInstanceProps');
  });
</script>

<div id="testXhrToDisallowedUrl" class="testcontainer">
  XHR to disallowed URL
</div>
<script type="text/javascript">
  jsunitRegister('testXhrToDisallowedUrl',
                 function testXhrToDisallowedUrl() {
    var xhr;

    xhr = new window.XMLHttpRequest();
    expectFailure(function() {
        xhr.open('GET', 'badscheme://xhrTest.txt', false);
        xhr.send();
      }, 'xhr to disallowed url');
    pass('testXhrToDisallowedUrl');
  });
</script>

<div id="testXhrSync" class="testcontainer">XHR sync</div>
<script type="text/javascript">
  jsunitRegister('testXhrSync',
                 function testXhrSync() {
    var xhr;

    // Check that response text is available after a synchronous XHR
    xhr = new window.XMLHttpRequest();
    xhr.open('GET', './xhrTest.txt', false);
    console.log('About to do sync xhr.send() - may get preempted');
    xhr.send();
    assertEquals('The quick brown fox', xhr.responseText);

    // Check that a synchronous XHR invokes its callback in ready state 4
    var statesSeen = [];
    var responseText;
    xhr = new window.XMLHttpRequest();
    // Note we specify test id since we get preempted by xhr.send()
    xhr.onreadystatechange = jsunitCallback(
        function onreadystatechangecb() {
          statesSeen.push(xhr.readyState);
          if (xhr.readyState == 4) {
            responseText = xhr.responseText;
          }
        },
        'testXhrSync');
    xhr.open('GET', './xhrTest.txt', false);
    // May or may not get a state 1 callback.
    assertContains('' + statesSeen, ['', '1']);
    statesSeen = [];

    console.log('About to do sync xhr.send() - may get preempted');
    xhr.send();

    assertEquals('4', '' + statesSeen);
    assertEquals('The quick brown fox', responseText);

    pass('testXhrSync');
  });
</script>

<div id="testXhrAsync" class="waiting testcontainer">XHR async</div>
<script type="text/javascript">
  jsunitRegister('testXhrAsync',
                 function testXhrAsync() {
    var xhr = new window.XMLHttpRequest();
    xhr.open('GET', './xhrTest.txt', true);
    var asyncFlag = 'PRE';
    xhr.onreadystatechange = jsunitCallback(function(event) {
      assertEquals(xhr, event.target);
      if (event.target.readyState === 4) {
        assertNotEquals(4, asyncFlag);
        asyncFlag = 'DONE';
        assertEquals('The quick brown fox', event.target.responseText);
        pass('testXhrAsync');
      }
      asyncFlag = event.target.readyState;
    });
    xhr.send();
  });
</script>

<div id="testXhrError" class="testcontainer">XHR callback errors</div>
<script type="text/javascript">
  jsunitRegister('testXhrError',
                 function testXhrError() {
    var xhr = new window.XMLHttpRequest();
    xhr.open('GET', './xhrTest.txt', true);
    xhr.onreadystatechange = function(event) {  // NOT a jsunitCallback
      if (event.target.readyState === 4) {
        installOneShotOnerror(
            'testXhrError',
            'Uncaught testXhrError');
        throw 'testXhrError';
      }
    };
    xhr.send();
  });
</script>

<p id="testEventMutation" class="clickme testcontainer">testEventMutation
    <span>(Assignment to properties of events)</span></p>
<script type="text/javascript">
  jsunitRegister('testEventMutation',
                 function testEventMutation() {
    document.getElementById('testEventMutation')
        .addEventListener('click', jsunitCallback(function(e) {

      // Tamed properties
      assertTrue('target' in e);  // prevent trivial pass
      for (var p in e) {
        var original = directAccess.getFeralProperty(e, p);
        if (p === 'target') {
          // prevent trivial pass
          assertEquals('object', typeof original);
        }
        var v = {};
        e[p] = v;
        assertEquals(p + ' set #1', v, e[p]);
        e[p] = 'foo';
        assertEquals(p + ' set #2', 'foo', e[p]);
        assertTrue(p + ' host value preserved',
            original === directAccess.getFeralProperty(e, p));
      }

      // Expando property
      e.florb = 44;
      assertEquals(44, e.florb);
      assertTrue('expando not found',
          undefined === directAccess.getFeralProperty(e, 'florb'));

      pass('testEventMutation');
    }), false);
  });
</script>

<script>
  function runEventDispatchTest(type, eventTarget, constructEvent,
      assertProperties, assertFinally) {
    withFailureOnLeakedEvent(type, function() {
       // Event dispatch for custom events is synchronous
      var fired = false;
      var eventToSend;

      eventTarget.addEventListener(type, jsunitCallback(function(event) {
        // assertEquals("received correct event", eventToSend, event);
        assertProperties(event);
        fired = true;
      }), true);

      eventToSend = constructEvent();
      var dispatchResult = eventTarget.dispatchEvent(eventToSend);
      assertTrue('event did fire', fired);

      assertFinally(dispatchResult);
    });
  }
</script>

<p id="testCustomEvents" class="testcontainer">Custom Events<br></p>
<script type="text/javascript">
  jsunitRegister('testCustomEvents',
                 function testCustomEvents() {
    assertTrue('createEvent exists', !!document.createEvent);

    runEventDispatchTest(
        'howdy',
        document.getElementById('testCustomEvents'),
        function constructEvent() {
          var eventToSend = document.createEvent('HTMLEvents');
          // TODO(kpreid): What's the intent here? .details is not standard;
          // are we testing that expando properties are preserved?
          eventToSend.details = 'hiya';
          eventToSend.initEvent('howdy', true, true);
          return eventToSend;
        },
        function assertProperties(event) {
          assertEquals("received correct details", 'hiya', event.details);
        },
        function assertFinally(dispatchResult) {
          assertEquals('dispatchEvent return value', true, dispatchResult);
        });
    pass('testCustomEvents');
  });
</script>

<!--

    TODO(ihab.awad): This is invalid for ES53; look at it and
    see if there's anything useful left.

<p class="testcontainer" id="testThisInEventHandlers"
 ><input type="checkbox" id="testThisInEventHandlers-1" />
</p>
<script type="text/javascript">
  jsunitRegister('testThisInEventHandlers',
                 function testThisInEventHandlers() {
    var inp = document.getElementById('testThisInEventHandlers-1');

    // By declaring f() to be cajita, but supplying it as the 'call'
    // property of the object passed to the event listener, we get
    // access to the value the function is supposed to use for the
    // 'this' keyword, even in cajita.
    var f = jsunitCallback(
        function fcb($dis, event, thisNode) {
          'use strict';
          'use cajita';
          // In an event handler, "this" should be bound to the node.
          assertEquals($dis, thisNode);
          pass('testThisInEventHandlers');
        });
    inp.addEventListener('click', {call: f}, false);
    directAccess.click(inp);
  });
</script>

-->

<p id="testDispatchedNoncustom" class="testcontainer">
  Programmatically dispatched mouse by
  <input id="testDispatchedNoncustom-c" type="checkbox">.dispatchEvent()
</p>
<script type="text/javascript">
  jsunitRegister('testDispatchedNoncustom',
                 function testDispatchedNoncustom() {
    var eventTarget = document.getElementById('testDispatchedNoncustom-c');
    runEventDispatchTest(
        'click',
        eventTarget,
        function constructEvent() {
          var eventToSend = document.createEvent('MouseEvents');
          eventToSend.initMouseEvent('click', true, true, window, 1, 7, 0, 0, 0,
              false, false, false, false, 0, null);

          assertEquals('check initial state', false, eventTarget.checked);

          return eventToSend;
        },
        function assertProperties(event) {
          assertEquals('received correct data', 7, event.screenX);
        },
        function assertFinally(dispatchResult) {
          assertEquals('dispatchEvent return value', true, dispatchResult);
          assertEquals('check final state not changed', false,
            eventTarget.checked);
        });
    pass('testDispatchedNoncustom');
  });
</script>

<p id="testStopPropagation" class="testcontainer">
  <span id="testStopPropagation-inner">testStopPropagation</span>
</p>
<script type="text/javascript">
  jsunitRegister('testStopPropagation', function() {
    var outerFired = false;
    document.getElementById('testStopPropagation').addEventListener(
        'foo', function(event) { outerFired = true; }, false);
    runEventDispatchTest(
        'foo',
        document.getElementById('testStopPropagation-inner'),
        function constructEvent() {
          var eventToSend = document.createEvent('Events');
          eventToSend.initEvent('foo', true, true);
          return eventToSend;
        },
        function assertProperties(event) {
          event.stopPropagation();
        },
        function assertFinally(dispatchResult) {
          assertEquals('dispatchEvent return value', true, dispatchResult);
          assertFalse('event was stopped', outerFired);
        });
    pass();
  });
</script>

<p id="testPreventDefault" class="testcontainer">testPreventDefault</p>
<script type="text/javascript">
  jsunitRegister('testPreventDefault', function() {
    runEventDispatchTest(
        'foo',
        document.getElementById('testPreventDefault'),
        function constructEvent() {
          var eventToSend = document.createEvent('Events');
          eventToSend.initEvent('foo', true, true);
          return eventToSend;
        },
        function assertProperties(event) {
          event.preventDefault();
        },
        function assertFinally(dispatchResult) {
          assertEquals('dispatchEvent return value', false, dispatchResult);
        });
    pass();
  });
</script>

<p id="testInitEvent" class="testcontainer">testInitEvent - all variants</p>
<script type="text/javascript">
  jsunitRegister('testInitEvent',
                 function testInitEvent() {
    var event;

    // initEvent
    event = document.createEvent('HTMLEvents');
    event.initEvent('howdy', true, false);
    assertEquals('initEvent type', 'howdy', event.type);
    assertEquals('initEvent bubbles', true, event.bubbles);
    assertEquals('initEvent cancelable', false, event.cancelable);

    event = document.createEvent('HTMLEvents');
    event.initEvent('howdy', false, true);
    assertEquals('initEvent bubbles #2', false, event.bubbles);
    assertEquals('initEvent cancelable #2', true, event.cancelable);

    // initUIEvent
    event = document.createEvent('UIEvents');
    event.initUIEvent('foo', true, false, window, 2);
    assertEquals('initUIEvent type', 'foo', event.type);
    assertEquals('initUIEvent bubbles', true, event.bubbles);
    assertEquals('initUIEvent cancelable', false, event.cancelable);
    assertEquals('initUIEvent view', window, event.view);
    assertEquals('initUIEvent detail', 2, event.detail);

    event = document.createEvent('UIEvents');
    event.initUIEvent('foo', false, true, {}, 'a');
    assertEquals('initUIEvent bubbles #2', false, event.bubbles);
    assertEquals('initUIEvent cancelable #2', true, event.cancelable);
    assertEquals('initUIEvent bad view', null, event.view);
    assertEquals('initUIEvent bad detail', 0, event.detail);

    // initMouseEvent
    event = document.createEvent('MouseEvents');
    event.initMouseEvent(
        'mousemove', true, false, window, 2,
        3, 4, 5, 6, false, true, false, true, 7, document.body);
    assertEquals('initMouseEvent type', 'mousemove', event.type);
    assertEquals('initMouseEvent bubbles', true, event.bubbles);
    assertEquals('initMouseEvent cancelable', false, event.cancelable);
    assertEquals('initMouseEvent view', window, event.view);
    assertEquals('initMouseEvent detail', 2, event.detail);
    assertEquals('initMouseEvent screenX', 3, event.screenX);
    assertEquals('initMouseEvent screenY', 4, event.screenY);
    assertEquals('initMouseEvent clientX', 5, event.clientX);
    assertEquals('initMouseEvent clientY', 6, event.clientY);
    assertEquals('initMouseEvent ctrlKey', false, event.ctrlKey);
    assertEquals('initMouseEvent altKey', true, event.altKey);
    assertEquals('initMouseEvent shiftKey', false, event.shiftKey);
    assertEquals('initMouseEvent metaKey', true, event.metaKey);
    assertEquals('initMouseEvent button', 7, event.button);
    assertEquals('initMouseEvent relatedTarget', document.body,
        event.relatedTarget);

    // initKeyboardEvent/initKeyEvent (ack TODO)
    var keyboardOK = false;
    if (event.initKeyboardEvent) {
      event = document.createEvent('KeyboardEvent');
      // per MDN 2013-01-29
      event.initKeyboardEvent(
          'keydown', true, false, window,
          'q', 'q', 0, '', false, 'jbo_US');
      // would test a value for modifiers arg, but it seems to misbehave on
      // Chrome (24.0.1312.56, 26.0.1394.0).
      assertEquals('initKeyboardEvent type', 'keydown', event.type);
      assertEquals('initKeyboardEvent bubbles', true, event.bubbles);
      assertEquals('initKeyboardEvent cancelable', false, event.cancelable);
      assertEquals('initKeyboardEvent view', window, event.view);
      if (directAccess.feralFeatureTest(event, 'char')) {
        assertEquals('initKeyboardEvent char', 'q', event.char);
      }
      if (directAccess.feralFeatureTest(event, 'key')) {
        assertEquals('initKeyboardEvent key', 'q', event.key);
      }
      assertEquals('initKeyboardEvent charCode', 0, event.charCode);
      assertEquals('initKeyboardEvent keyCode', 0, event.keyCode);
          // yes, not code of 'q' -- per Chrome 26.0.1394.0
      if (directAccess.feralFeatureTest(event, 'location')) {
        assertEquals('initKeyboardEvent location', 0, event.location);
      }
      assertEquals('initKeyboardEvent ctrlKey', false, event.ctrlKey);
      assertEquals('initKeyboardEvent altKey', false, event.altKey);
      assertEquals('initKeyboardEvent shiftKey', false, event.shiftKey);
      assertEquals('initKeyboardEvent metaKey', 'boolean',
          typeof event.metaKey);  // value is odd so not testing it
      // described in MDN but not provided by Chrome or Firefox:
      //assertEquals('initKeyboardEvent repeat', false, event.repeat);
      //assertEquals('initKeyboardEvent locale', 'jbo_US', event.locale);
      keyboardOK = true;
    }
    if (event.initKeyEvent) {
      event = document.createEvent('KeyboardEvent');
      // per MDN 2013-01-29
      event.initKeyEvent(
          'keydown', true, false, window,
          false, false, true, false,
          'Q'.charCodeAt(0), 0);
      assertEquals('initKeyEvent type', 'keydown', event.type);
      assertEquals('initKeyEvent bubbles', true, event.bubbles);
      assertEquals('initKeyEvent cancelable', false, event.cancelable);
      assertEquals('initKeyEvent view', window, event.view);
      if (directAccess.feralFeatureTest(event, 'char')) {
        assertEquals('initKeyboardEvent char', 'q', event.char);
      }
      // firefox 23 and 24 have event.key but it seems to always be ''
      if (directAccess.feralFeatureTest(event, 'key') &&
          directAccess.getFeralProperty(event, 'key') !== '') {
        assertEquals('initKeyboardEvent key', 'q', event.key);
      }
      assertEquals('initKeyEvent charCode', 0, event.charCode);
      //assertEquals('initKeyEvent keyCode', 'Q'.charCodeAt(0), event.keyCode);
          // TODO(kpreid): is coming from the browser as 0, not sure why
      assertEquals('initKeyEvent ctrlKey', false, event.ctrlKey);
      assertEquals('initKeyEvent altKey', false, event.altKey);
      assertEquals('initKeyEvent shiftKey', true, event.shiftKey);
      assertEquals('initKeyEvent metaKey', false, event.metaKey);
      keyboardOK = true;
    }
    assertTrue('one of initKeyboardEvent or initKeyEvent is available',
        keyboardOK);

    // worst-case detail value: see comments in initCustomEvent implementation
    // about the issues.
    var detailObj = new (function DetailTestCtor() {})();
    event = document.createEvent('CustomEvent');
    event.initCustomEvent('foo', false, true, detailObj);
    assertEquals('initCustomEvent type', 'foo', event.type);
    assertEquals('initCustomEvent bubbles', false, event.bubbles);
    assertEquals('initCustomEvent cancelable', true, event.cancelable);
    assertTrue('initCustomEvent detail', event.detail === detailObj);

    pass('testInitEvent');
  });
</script>

<p id="testInitEventSecurity" class="clickme testcontainer"><span>
  testInitEventSecurity -- initEvent cannot be used to mutate host events
</span></p>
<script type="text/javascript">
  jsunitRegister('testInitEventSecurity',
                 function testInitEventSecurity() {
    document.getElementById('testInitEventSecurity')
        .addEventListener('click', jsunitCallback(function(e) {
      // Currently non-custom events have no initEvent method at all, so we
      // try borrowing one.
      var initEvent = e.initEvent ||
          document.createEvent('MouseEvents').initEvent;
      // Browser behavior (Chrome, FF) is that initEvent has no effect after
      // dispatchEvent starts. Spec says initEvent "may only be called" before
      // dispatchEvent <http://www.w3.org/TR/DOM-Level-2-Events/events.html>,
      // but that's awfully vague, hence this test.
      initEvent.call(e, 'clank', false, false);
      assertEquals('click', e.type);
      assertEquals('click', directAccess.getFeralProperty(e, 'type'));
      pass('testInitEventSecurity');
    }), false);
  });
</script>

<p id="testNonTouchEvents" class="testcontainer">testNonTouchEvents</p>
<script type="text/javascript">
  jsunitRegister('testNonTouchEvents', function() {
    // Check that we don't have broken touch accessors on non-touch events
    var e = document.createEvent('Events');
    e.initEvent(e, 'foo', false, false);
    assertEquals('touches', undefined, e.touches);
    assertEquals('targetTouches', undefined, e.targetTouches);
    assertEquals('changedTouches', undefined, e.changedTouches);
    pass();
  });
</script>
